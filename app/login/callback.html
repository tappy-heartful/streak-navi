<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../images/favicon.png" type="image/png" />
    <link
      rel="apple-touch-icon"
      href="../../images/favicon.png"
      type="image/png"
    />
    <title>èª­ã¿è¾¼ã¿ä¸­...</title>
    <link rel="stylesheet" href="../../common.css" />
  </head>
  <body>
    <h1 style="text-align: center">èª­ã¿è¾¼ã¿ä¸­...</h1>
    <div id="message"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../functions.js"></script>
    <script>
      // å…ˆé ­ã« sleep é–¢æ•°ã‚’è¿½åŠ 
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
      (async () => {
        const clientId = getSession('clientId'); // ã‚ãªãŸã®LINEãƒãƒ£ãƒãƒ«ID
        const baseUrl = getSession('isProd')
          ? getSession('urlBaseProd') // æœ¬ç•ªç’°å¢ƒã®å ´åˆã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±(github Pagesã¯ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¾ã§ã‚ã‚‹ãŸã‚)
          : window.location.origin; // ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å ´åˆã€ä»Šã®ãƒ™ãƒ¼ã‚¹URLã«çµåˆ
        const redirectUri = baseUrl + '/app/login/callback.html';

        const clientSecret = '126dea4d33dd7deca8d6ee9b7870237f'; // å¿…è¦ãªã‚‰ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ï¼‰

        // â‘  ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ code ã¨ state ã‚’å–å¾—
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        if (error) {
          alert('LINEãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          return;
        }

        if (!code || !state) {
          alert('ç„¡åŠ¹ãªLINEãƒ­ã‚°ã‚¤ãƒ³å¿œç­”ã§ã™');
          return;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        $('#message').append('âœ…LINE èªè¨¼æˆåŠŸ<br>');

        try {
          // â‘¡ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆCORSåˆ¶é™ãŒã‚ã‚‹ãŸã‚é€šå¸¸ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±ï¼‰
          const tokenResponse = await fetch(
            'https://api.line.me/oauth2/v2.1/token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                client_id: clientId,
                client_secret: clientSecret, // ã‚»ã‚­ãƒ¥ã‚¢ãªå‡¦ç†ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¨å¥¨
              }),
            }
          );

          const tokenData = await tokenResponse.json();
          if (!tokenData.access_token) {
            throw new Error('ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          $('#message').append('âœ…LINE ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ<br>');

          const accessToken = tokenData.access_token;

          // â‘¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
          const profileResponse = await fetch(
            'https://api.line.me/v2/profile',
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          const profile = await profileResponse.json();

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          $('#message').append('âœ…LINE ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ<br>');
          $('#message').append('<br>All Processes OK (ã€œï¿£â–½ï¿£)ã€œ');

          // ğŸ‘‡ã“ã“ã§1ç§’å¾…æ©Ÿ(éŠã³å¿ƒ)
          await sleep(1000);

          // â‘£ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã€ã¾ãŸã¯æ¬¡ã®ç”»é¢ã«æ¸¡ã™
          setSessionArray('line_profile', profile);

          // â‘¤ ãƒ­ã‚°ã‚¤ãƒ³å¾ŒTOPãƒšãƒ¼ã‚¸ã¸é·ç§»
          window.location.href = baseUrl + '/app/top/top.html';
        } catch (err) {
          console.error('LINEãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', err);
          $('#message').append(
            'LINEãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:' + err
          );
          alert(
            'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\næ¡ä»¶ã‚’å¤‰ãˆã¦ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¦ãã ã•ã„'
          );
          // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»(ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ãã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã‚’è€ƒæ…®)
          window.location.href = window.location.href.includes('tappy-heartful')
            ? 'https://tappy-heartful.github.io/streak-navi'
            : window.location.origin;
        }
      })();
    </script>
  </body>
</html>
