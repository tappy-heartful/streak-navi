<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../images/favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="../../images/favicon.png" />
    <title>èª­ã¿è¾¼ã¿ä¸­...</title>
    <link rel="stylesheet" href="../common/common.css" />
  </head>
  <body>
    <h1 style="text-align: center">èª­ã¿è¾¼ã¿ä¸­...</h1>
    <div id="message"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module" src="../common/functions.js"></script>

    <script type="module">
      import * as utils from '../common/functions.js';

      (async () => {
        $('#message').append('LINE èªè¨¼ä¸­...<br>');

        const redirectUri = utils.globalBaseUrl + '/app/login/callback.html';
        const clientSecret = '126dea4d33dd7deca8d6ee9b7870237f';

        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        if (error) {
          alert('LINEãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          return;
        }

        if (!code || !state) {
          alert('ç„¡åŠ¹ãªLINEãƒ­ã‚°ã‚¤ãƒ³å¿œç­”ã§ã™');
          return;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        $('#message').append('âœ…æˆåŠŸ<br><br>');

        try {
          $('#message').append(
            'LINE ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»IDãƒˆãƒ¼ã‚¯ãƒ³ å–å¾—ä¸­...<br>'
          );

          // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ + id_token å–å¾—
          const tokenResponse = await fetch(
            'https://api.line.me/oauth2/v2.1/token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                client_id: utils.globalClientId,
                client_secret: clientSecret,
              }),
            }
          );

          const tokenData = await tokenResponse.json();
          if (!tokenData.access_token || !tokenData.id_token) {
            throw new Error(
              'ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯IDãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—: ' +
                JSON.stringify(tokenData)
            );
          }

          $('#message').append('âœ…æˆåŠŸ<br><br>');

          const accessToken = tokenData.access_token;
          const idToken = tokenData.id_token;

          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
          $('#message').append('LINE ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ä¸­...<br>');
          const profileResponse = await fetch(
            'https://api.line.me/v2/profile',
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          const profile = await profileResponse.json();
          if (!profile) {
            throw new Error(
              'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(profile)
            );
          }

          $('#message').append('âœ…æˆåŠŸ<br><br>');

          // ğŸ” ç‹¬è‡ªèªè¨¼ã‚µãƒ¼ãƒãƒ¼ã¸IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
          $('#message').append('ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ä¸­...<br>');
          const verifyResponse = await fetch(
            'https://streak-navi-auth-server.onrender.com/verify-line-token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ idToken }),
            }
          );

          const verifyResult = await verifyResponse.json();
          if (!verifyResponse.ok || !verifyResult.customToken) {
            throw new Error(
              'ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—: ' + JSON.stringify(verifyResult)
            );
          }

          $('#message').append('âœ…æˆåŠŸ<br><br>');

          const customToken = verifyResult.customToken;

          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜
          utils.setSessionArray('line_profile', profile);
          utils.setSession('custom_token', customToken);

          // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§Firebase ãƒ­ã‚°ã‚¤ãƒ³
          $('#message').append('Firebaseãƒ­ã‚°ã‚¤ãƒ³ä¸­...<br>');
          const userCredential = await utils
            .signInWithCustomToken(utils.auth, customToken)
            .catch((error) => {
              throw new Error('Firebaseãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + JSON.stringify(error));
            });
          const user = userCredential.user;
          // âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
          $('#message').append('âœ…æˆåŠŸ<br><br>');

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          const userRef = utils.doc(utils.db, 'users', user.uid);
          const docSnap = await utils.getDoc(userRef);
          const userExists = docSnap.exists();
          $('#message').append(
            'ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿' + (userExists ? 'æ›´æ–°' : 'ç™»éŒ²') + 'ä¸­...<br>'
          );

          if (userExists) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å­˜åœ¨
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°(è¡¨ç¤ºåã®ã¿)
            await utils.setDoc(userRef, {
              displayName: user.displayName,
              updatedAt: utils.serverTimestamp(),
              updateUser: user.uid,
            });
          } else {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿éå­˜åœ¨
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ç™»éŒ²
            await utils.setDoc(userRef, {
              displayName: user.displayName,
              userAdminFlg: 0, //TODOä¸è¦ã‹ï¼Ÿ
              voteAdminFlg: 0, //TODOä¸è¦ã‹ï¼Ÿ
              createdAt: utils.serverTimestamp(),
              createdUser: user.uid,
              updatedAt: utils.serverTimestamp(),
              updateUser: user.uid,
            });
          }

          // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          $('#message').append('âœ…æˆåŠŸ<br><br>');

          // âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
          $('#message').append('<br>âœ…All Processes OK (ã€œï¿£â–½ï¿£)ã€œ');

          // TOPã¾ãŸã¯åŒæ„ç”»é¢ã¸é·ç§» TODO æ–°è¦ãƒ¦ãƒ¼ã‚¶ã‹ã©ã†ã‹åˆ¤å®š
          window.location.href =
            utils.globalBaseUrl +
            (userExists ? '/app/top/top.html' : '/app/login/consent.html');
        } catch (err) {
          console.error('ã‚¨ãƒ©ãƒ¼:', err);
          $('#message').append('ã‚¨ãƒ©ãƒ¼: ' + err.message);
          if (
            confirm('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\nãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')
          ) {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»
            window.location.href = window.location.origin;
          }
        }
      })();
    </script>
  </body>
</html>
