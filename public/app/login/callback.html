<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../images/favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="../../images/favicon.png" />
    <title>読み込み中...</title>
    <link rel="stylesheet" href="../common/common.css" />
  </head>
  <body>
    <h1 style="text-align: center">読み込み中...</h1>
    <div id="message"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module" src="../common/functions.js"></script>

    <script type="module">
      import * as utils from '../common/functions.js';

      (async () => {
        $('#message').append('LINE 認証中...<br>');

        const redirectUri = utils.globalBaseUrl + '/app/login/callback.html';
        const clientSecret = '126dea4d33dd7deca8d6ee9b7870237f';

        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        if (error) {
          alert('LINEログインに失敗しました: ' + error);
          return;
        }

        if (!code || !state) {
          alert('無効なLINEログイン応答です');
          return;
        }

        // メッセージ表示
        $('#message').append('✅成功<br><br>');

        try {
          $('#message').append(
            'LINE アクセストークン・IDトークン 取得中...<br>'
          );

          // アクセストークン + id_token 取得
          const tokenResponse = await fetch(
            'https://api.line.me/oauth2/v2.1/token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                client_id: utils.globalClientId,
                client_secret: clientSecret,
              }),
            }
          );

          const tokenData = await tokenResponse.json();
          if (!tokenData.access_token || !tokenData.id_token) {
            throw new Error(
              'アクセストークンまたはIDトークンの取得に失敗: ' +
                JSON.stringify(tokenData)
            );
          }

          $('#message').append('✅成功<br><br>');

          const accessToken = tokenData.access_token;
          const idToken = tokenData.id_token;

          // プロフィール取得
          $('#message').append('LINE プロフィール取得中...<br>');
          const profileResponse = await fetch(
            'https://api.line.me/v2/profile',
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          const profile = await profileResponse.json();
          if (!profile) {
            throw new Error(
              'プロフィールの取得に失敗しました: ' + JSON.stringify(profile)
            );
          }

          $('#message').append('✅成功<br><br>');

          // 🔐 独自認証サーバーへIDトークンを送信（カスタムトークン取得）
          $('#message').append('カスタムトークン取得中...<br>');
          const verifyResponse = await fetch(
            'https://streak-navi-auth-server.onrender.com/verify-line-token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ idToken }),
            }
          );

          const verifyResult = await verifyResponse.json();
          if (!verifyResponse.ok || !verifyResult.customToken) {
            throw new Error(
              'カスタムトークンの取得に失敗: ' + JSON.stringify(verifyResult)
            );
          }

          $('#message').append('✅成功<br><br>');

          const customToken = verifyResult.customToken;

          // セッションにプロフィールとトークン保存
          utils.setSessionArray('line_profile', profile);
          utils.setSession('custom_token', customToken);

          // カスタムトークンでFirebase ログイン
          $('#message').append('Firebaseログイン中...<br>');
          const userCredential = await utils
            .signInWithCustomToken(utils.auth, customToken)
            .catch((error) => {
              throw new Error('Firebaseログイン失敗: ' + JSON.stringify(error));
            });
          const user = userCredential.user;
          // ✅ ログイン成功
          $('#message').append('✅成功<br><br>');

          // ユーザーデータ更新
          const userRef = utils.doc(utils.db, 'users', user.uid);
          const docSnap = await utils.getDoc(userRef);
          const userExists = docSnap.exists();
          $('#message').append(
            'ユーザデータ' + (userExists ? '更新' : '登録') + '中...<br>'
          );

          if (userExists) {
            // ユーザーデータ存在
            // ユーザー情報更新(表示名のみ)
            await utils.setDoc(userRef, {
              displayName: user.displayName,
              updatedAt: utils.serverTimestamp(),
              updateUser: user.uid,
            });
          } else {
            // ユーザーデータ非存在
            // ユーザー新規登録
            await utils.setDoc(userRef, {
              displayName: user.displayName,
              userAdminFlg: 0, //TODO不要か？
              voteAdminFlg: 0, //TODO不要か？
              createdAt: utils.serverTimestamp(),
              createdUser: user.uid,
              updatedAt: utils.serverTimestamp(),
              updateUser: user.uid,
            });
          }

          // ✅ ユーザーデータ更新
          $('#message').append('✅成功<br><br>');

          // ✅ ログイン成功
          $('#message').append('<br>✅All Processes OK (〜￣▽￣)〜');

          // TOPまたは同意画面へ遷移 TODO 新規ユーザかどうか判定
          window.location.href =
            utils.globalBaseUrl +
            (userExists ? '/app/top/top.html' : '/app/login/consent.html');
        } catch (err) {
          console.error('エラー:', err);
          $('#message').append('エラー: ' + err.message);
          if (
            confirm('ログイン処理に失敗しました\nログイン画面に戻りますか？')
          ) {
            // ログインページへ遷移
            window.location.href = window.location.origin;
          }
        }
      })();
    </script>
  </body>
</html>
