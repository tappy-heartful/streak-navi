<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../images/favicon.png" type="image/png" />
    <link
      rel="apple-touch-icon"
      href="../../images/favicon.png"
      type="image/png"
    />
    <title>読み込み中...</title>
    <link rel="stylesheet" href="../common/common.css" />
  </head>
  <body>
    <h1 style="text-align: center">読み込み中...</h1>
    <div id="message"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../common/functions.js"></script>
    <script>
      // 先頭に sleep 関数を追加
      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      // コールバック処理
      (async () => {
        const redirectUri = globalBaseUrl + '/app/login/callback.html';

        const clientSecret = '126dea4d33dd7deca8d6ee9b7870237f'; // 必要なら（セキュアなバックエンドで）

        // ① クエリパラメータから code と state を取得
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        if (error) {
          alert('LINEログインに失敗しました: ' + error);
          return;
        }

        if (!code || !state) {
          alert('無効なLINEログイン応答です' + error);
          return;
        }

        // メッセージ表示
        $('#message').append('✅LINE 認証成功<br>');

        try {
          // ② アクセストークン取得（CORS制限があるため通常はバックエンド経由）
          const tokenResponse = await fetch(
            'https://api.line.me/oauth2/v2.1/token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                client_id: globalClientId,
                client_secret: clientSecret, // セキュアな処理はバックエンド推奨
              }),
            }
          );

          const tokenData = await tokenResponse.json();
          if (!tokenData.access_token) {
            throw new Error(
              'アクセストークンの取得に失敗しました' + JSON.stringify(tokenData)
            );
          }

          // メッセージ表示
          $('#message').append('✅LINE アクセストークン取得成功<br>');

          const accessToken = tokenData.access_token;

          // ③ ユーザープロフィール取得
          const profileResponse = await fetch(
            'https://api.line.me/v2/profile',
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          const profile = await profileResponse.json();

          if (!profile) {
            throw new Error(
              'アクセストークンの取得に失敗しました' + JSON.stringify(profile)
            );
          }

          // メッセージ表示
          $('#message').append('✅LINE プロフィール取得成功<br>');
          $('#message').append('<br>All Processes OK (〜￣▽￣)〜');

          // ④ プロフィールをセッションに保存、または次の画面に渡す
          setSessionArray('line_profile', profile);

          // ⑤ ログイン後TOPページ/同意確認ページへ遷移 TODO ユーザがあるかどうかの判定
          window.location.href =
            globalBaseUrl +
            (false ? '/app/top/top.html' : '/app/login/consent.html');
        } catch (err) {
          console.error('LINEログイン処理中にエラーが発生しました:', err);
          $('#message').append(
            'LINEログイン処理中にエラーが発生しました:' + err
          );
          if (
            confirm('ログイン処理に失敗しました\nログイン画面に戻りますか？')
          ) {
            // ログインページへ遷移(セッションが正しくセットされていない場合を考慮)
            window.location.href = window.location.href.includes(
              'tappy-heartful'
            )
              ? 'https://tappy-heartful.github.io/streak-navi'
              : window.location.origin;
          }
        }
      })();
    </script>
  </body>
</html>
