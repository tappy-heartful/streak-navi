<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../images/favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="../../images/favicon.png" />
    <title>読み込み中...</title>
    <link rel="stylesheet" href="../common/common.css" />
  </head>
  <body>
    <h1 style="text-align: center">読み込み中...</h1>
    <div id="message"></div>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module" src="../common/functions.js"></script>

    <script type="module">
      import * as utils from '../common/functions.js';

      (async () => {
        try {
          // スピナー表示
          utils.showSpinner();

          $('#message').append('LINE 認証中...<br>');

          const redirectUri = utils.globalBaseUrl + '/app/login/callback.html';
          const code = utils.globalGetParamCode;
          const state = utils.globalGetParamState;
          const error = utils.globalGetParamError;

          if (error) {
            throw new Error('LINEログインに失敗しました: ' + error);
          }

          if (!code || !state) {
            throw new Error('無効なLINEログイン応答です');
          }

          // 保存されたstateを取り出して比較（CSRF対策）
          const savedState = localStorage.getItem('oauthState');
          if (!savedState) {
            throw new Error(
              '認証セッションが見つかりません。もう一度ログインしてください。'
            );
          }
          if (savedState !== state) {
            throw new Error('不正なリクエストです（state不一致）。');
          }
          // 一致したらstateは使い終わったので削除
          localStorage.removeItem('oauthState');

          // メッセージ表示
          $('#message').append('✅成功<br><br>');

          $('#message').append(
            'LINE プロフィール情報・カスタムトークン取得中...<br>'
          );

          // 認証サーバーのlineログインAPI実行
          const loginResponse = await fetch(utils.globalAuthServerRailway, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, redirectUri }),
          });

          const { customToken, profile } = await loginResponse.json();

          if (!customToken) throw new Error('カスタムトークン取得失敗');

          // ✅ LINE プロフィール情報・カスタムトークン取得成功
          $('#message').append('✅成功<br><br>');

          // カスタムトークンでFirebase ログイン
          $('#message').append('Firebaseログイン中...<br>');
          const userCredential = await utils
            .signInWithCustomToken(utils.auth, customToken)
            .catch((error) => {
              throw new Error('Firebaseログイン失敗: ' + JSON.stringify(error));
            });
          const user = userCredential.user;
          utils.setSession('uid', user.uid); // 認証済みuidを保存
          // ✅ ログイン成功
          $('#message').append('✅成功<br><br>');

          // ユーザーデータ更新(LINEIDはハッシュ化して保存)
          const userRef = utils.doc(utils.db, 'users', user.uid);
          const docSnap = await utils.getDoc(userRef);
          const userExists = docSnap.exists();
          const displayName = profile.displayName || '名無し';
          const pictureUrl = profile.pictureUrl || utils.globalLineDefaultImage;
          $('#message').append(
            'ユーザデータ' + (userExists ? '更新' : '登録') + '中...<br>'
          );

          if (userExists) {
            // ユーザーデータ存在
            // ユーザー情報更新
            await utils.setDoc(
              userRef,
              {
                displayName,
                pictureUrl,
                lastLoginAt: utils.serverTimestamp(),
              },
              { merge: true }
            );
          } else {
            // ユーザーデータ非存在
            // ユーザー新規登録
            await utils.setDoc(userRef, {
              displayName,
              pictureUrl,
              lastLoginAt: utils.serverTimestamp(),
              createdAt: utils.serverTimestamp(),
              roleId: utils.globalStrUnset,
              sectionId: utils.globalStrUnset,
            });
          }

          // ✅ ユーザーデータ更新成功
          $('#message').append('✅成功<br><br>');

          // ユーザデータをセッションに格納
          $('#message').append('ユーザデータ取得中...<br>');

          const latestUserSnap = await utils.getDoc(userRef);
          if (!latestUserSnap.exists()) {
            throw new Error('ユーザーデータが存在しません');
          }
          const latestUserData = latestUserSnap.data();
          // 1項目ずつセッションに保存
          for (const [key, value] of Object.entries(latestUserData)) {
            utils.setSession(key, value);
          }
          // ✅ ユーザーデータ取得成功
          $('#message').append('✅成功<br><br>');

          // ✅ ログイン成功
          $('#message').append('<br>✅All Processes OK (〜￣▽￣)〜');

          // リダイレクト先取得
          const redirectAfterLogin = localStorage.getItem('redirectAfterLogin');
          localStorage.removeItem('redirectAfterLogin');

          // 初回ログイン：同意画面へ遷移
          // ログイン後の遷移先に指定がある：その画面へ遷移
          // 上記以外：TOPへ遷移
          window.location.href = userExists
            ? redirectAfterLogin ??
              utils.globalBaseUrl + '/app/top/top.html?fromLogin=1'
            : utils.globalBaseUrl + '/app/login/consent.html';
        } catch (e) {
          $('#message').append('エラー: ' + e.message);

          // ログ登録
          await utils.writeLog({
            dataId: 'none',
            action: 'ログイン',
            status: 'error',
            errorDetail: { message: e.message, stack: e.stack },
          });
        } finally {
          // スピナー非表示
          utils.hideSpinner();
        }
      })();
    </script>
  </body>
</html>
