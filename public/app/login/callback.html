<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../../images/favicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="../../images/favicon.png" />
    <title>èª­ã¿è¾¼ã¿ä¸­...</title>
    <link rel="stylesheet" href="../common/common.css" />
  </head>
  <body>
    <h1 style="text-align: center">èª­ã¿è¾¼ã¿ä¸­...</h1>
    <div id="message"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module" src="../common/functions.js"></script>

    <script type="module">
      import * as utils from '../common/functions.js';

      (async () => {
        $('#message').append('LINE èªè¨¼ä¸­...<br>');

        const redirectUri = utils.globalBaseUrl + '/app/login/callback.html';
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        if (error) {
          alert('LINEãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          return;
        }

        if (!code || !state) {
          alert('ç„¡åŠ¹ãªLINEãƒ­ã‚°ã‚¤ãƒ³å¿œç­”ã§ã™');
          return;
        }

        // ä¿å­˜ã•ã‚ŒãŸstateã‚’å–ã‚Šå‡ºã—ã¦æ¯”è¼ƒï¼ˆCSRFå¯¾ç­–ï¼‰
        const savedState = utils.getSession('oauthState');
        if (!savedState) {
          alert(
            'èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'
          );
          return;
        }
        if (savedState !== state) {
          alert('ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™ï¼ˆstateä¸ä¸€è‡´ï¼‰ã€‚');
          return;
        }
        // ä¸€è‡´ã—ãŸã‚‰stateã¯ä½¿ã„çµ‚ã‚ã£ãŸã®ã§å‰Šé™¤
        utils.removeSession('oauthState');

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        $('#message').append('âœ…æˆåŠŸ<br><br>');

        try {
          $('#message').append('LINE ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ä¸­...<br>');

          // ã“ã“ã‚’LINE APIç›´å©ãã‹ã‚‰è‡ªã‚µãƒ¼ãƒãƒ¼APIã¸å¤‰æ›´
          const tokenResponse = await fetch(
            'https://streak-navi-auth-server.onrender.com/exchange-line-token',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code, redirectUri }),
            }
          );

          const tokenData = await tokenResponse.json();
          if (!tokenData.access_token || !tokenData.id_token) {
            throw new Error(
              'ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯IDãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—: ' +
                JSON.stringify(tokenData)
            );
          }

          $('#message').append('âœ…æˆåŠŸ<br><br>');

          const accessToken = tokenData.access_token;
          const idToken = tokenData.id_token;

          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
          $('#message').append('LINE ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ä¸­...<br>');
          const profileResponse = await fetch(
            'https://api.line.me/v2/profile',
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          const profile = await profileResponse.json();
          if (!profile) {
            throw new Error(
              'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + JSON.stringify(profile)
            );
          }

          $('#message').append('âœ…æˆåŠŸ<br><br>');

          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜(UserIdã¯ãƒãƒƒã‚·ãƒ¥åŒ–)
          utils.setSession('lineUserId', await utils.getHash(profile.userId));
          utils.setSession('linePictureUrl', profile.pictureUrl);
          utils.setSession('lineDisplayName', profile.displayName);

          // ğŸ” ç‹¬è‡ªèªè¨¼ã‚µãƒ¼ãƒãƒ¼ã¸IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
          $('#message').append('ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ä¸­...<br>');
          const verifyResponse = await fetch(
            'https://streak-navi-auth-server.onrender.com/verify-line-token',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ idToken }),
            }
          );

          const verifyResult = await verifyResponse.json();
          if (!verifyResponse.ok || !verifyResult.customToken) {
            throw new Error(
              'ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—: ' + JSON.stringify(verifyResult)
            );
          }

          $('#message').append('âœ…æˆåŠŸ<br><br>');

          const customToken = verifyResult.customToken;

          // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§Firebase ãƒ­ã‚°ã‚¤ãƒ³
          $('#message').append('Firebaseãƒ­ã‚°ã‚¤ãƒ³ä¸­...<br>');
          const userCredential = await utils
            .signInWithCustomToken(utils.auth, customToken)
            .catch((error) => {
              throw new Error('Firebaseãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + JSON.stringify(error));
            });
          const user = userCredential.user;
          // âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
          $('#message').append('âœ…æˆåŠŸ<br><br>');

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°(LINEIDã¯ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜)
          const hashedUid = utils.getSession('lineUserId');
          const userRef = utils.doc(utils.db, 'users', hashedUid);
          const docSnap = await utils.getDoc(userRef);
          const userExists = docSnap.exists();
          $('#message').append(
            'ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿' + (userExists ? 'æ›´æ–°' : 'ç™»éŒ²') + 'ä¸­...<br>'
          );

          if (userExists) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å­˜åœ¨
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°(è¡¨ç¤ºåã‚„ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã“ã¨ã‚’è€ƒæ…®)
            await utils.setDoc(
              userRef,
              {
                displayName: profile.displayName,
                pictureUrl: profile.pictureUrl,
                lastLoginAt: utils.serverTimestamp(),
              },
              { merge: true }
            );
          } else {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿éå­˜åœ¨
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ç™»éŒ²
            await utils.setDoc(userRef, {
              displayName: profile.displayName,
              pictureUrl: profile.pictureUrl,
              userAdminFlg: false,
              voteAdminFlg: false,
              sectionId: 99,
              isPartLeader: false,
              lastLoginAt: utils.serverTimestamp(),
            });
          }

          // âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          $('#message').append('âœ…æˆåŠŸ<br><br>');

          // âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
          $('#message').append('<br>âœ…All Processes OK (ã€œï¿£â–½ï¿£)ã€œ');

          // TOPã¾ãŸã¯åŒæ„ç”»é¢ã¸é·ç§»
          window.location.href =
            utils.globalBaseUrl +
            (userExists ? '/app/top/top.html' : '/app/login/consent.html');
        } catch (err) {
          console.error('ã‚¨ãƒ©ãƒ¼:', err);
          $('#message').append('ã‚¨ãƒ©ãƒ¼: ' + err.message);
          if (
            confirm('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\nãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')
          ) {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»
            window.location.href = window.location.origin;
          }
        }
      })();
    </script>
  </body>
</html>
